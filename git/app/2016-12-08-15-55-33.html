<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title>刘阳phper</title>
	<meta http-equiv="X-UA-Compatible" content="IE=Edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="keywords" content="">
	<meta name="description" content="">

	<!-- stylesheet css -->
	<link rel="stylesheet" href="../theme/css/bootstrap.min.css">
	<link rel="stylesheet" href="../theme/css/font-awesome.min.css">
	<link rel="stylesheet" href="../theme/css/templatemo-blue.css">
</head>
<body data-spy="scroll" data-target=".navbar-collapse">

<!-- preloader section -->
<div class="preloader">
	<div class="sk-spinner sk-spinner-wordpress">
       <span class="sk-inner-circle"></span>
     </div>
</div>

<!-- header section -->
<header>
<!-- Fixed navbar -->
    <nav class="nav-skills navbar bg-skills navbar-fixed-top" role="navigation">
     <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="/">刘阳phper</a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
           <ul class="nav navbar-nav bg-skills">

            <li ><a href="http://www.yang95.com" >首页</a></li>

            <li><a  href="list.html">最近文章</a></li>

            <li><a href="http://yangakw.cn"  >查看博客</a>

            <li class="dropdown ">

              <a href="#" class="dropdown-toggle" data-toggle="dropdown">展示<span class="caret"></span></a>
              <ul class="dropdown-menu bg-skills" role="menu"> 
                <li><a href="/other/meizi/index.html">meizi</a></li> 
                <li class="divider"></li>
                <li><a href="/other/80s/index.html">80s</a></li>
 <li><a href="/other/animate.css/index.html">animate</a></li> 
              </ul>
            </li>
          </ul>
        
        </div><!--/.nav-collapse -->
      </div>
    </nav><!--/nav--->
	<div class="container">
		<div class="row">
			<div class="col-md-12 col-sm-12">
				<img src="../theme/images/tm-easy-profile.jpg" class="img-responsive img-circle tm-border" alt="templatemo easy profile">
				<hr>
				<h1 class="tm-title bold shadow">刘阳phper</h1>
				<h1 class="white bold shadow">yangakw@qq.com</h1>
			</div>
		</div>
	</div>
</header>

<!-- about and skills section -->
<section class="container">
	<div class="row">
		<div class="col-md-8 col-sm-12">
			<div class="about">
				<h3 class="accent">高性能缓存服务器Varnish解析</h3>
				<small>Varnish |http://history.programmer.com.cn/14315/ |Varnish </small>
				
				 <div width="95%">
							<p style="font-size:18px;font-family:微软雅黑;">
						<p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 14px; text-indent: 28px; color: rgb(0, 0, 0); font-family: &quot;Lucida Grande&quot;, &quot;Lucida Sans Unicode&quot;, Arial, Verdana, sans-serif; white-space: normal;">当前计算机系统的内存除了主存外，还包括<span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">CPU</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">的</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">L1</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">级缓存、</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">L2</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">级缓存，甚至还包括</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">L3</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">级缓存。硬盘也有缓存，而</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">Squid</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">的架构导致其无法做到最佳存取，但操作系统可以实现这部分功能，所以这部分工作应该交给操作系统来处理，这就是</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">Varnish Cache</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">设计架构。</span>挪威最大的在线报纸<span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">Verdens Gang(vg.no)</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">使用了</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">3</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">台</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">Varnish</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">服务器代替了原来的</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">12</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">台</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">Squid</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">服务器，而且性能比以前更好，这是</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">Varnish</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">最成功的应用案例之一。目前，</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">Varnish</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">可以在</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">FreeBSD6.0/7.0</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">、</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">Solaris</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">和</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">Linux 2.6</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">内核上运行。</span><strong style="margin: 0px; padding: 0px; border: 0px; outline: 0px;"></strong></p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 14px; text-indent: 28px; color: rgb(0, 0, 0); font-family: &quot;Lucida Grande&quot;, &quot;Lucida Sans Unicode&quot;, Arial, Verdana, sans-serif; white-space: normal;"><strong style="margin: 0px; padding: 0px; border: 0px; outline: 0px;">Varnish<span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 黑体;">的结构特点</span></strong></p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 14px; text-indent: 28px; color: rgb(0, 0, 0); font-family: &quot;Lucida Grande&quot;, &quot;Lucida Sans Unicode&quot;, Arial, Verdana, sans-serif; white-space: normal;">Varnish<span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">的先进设计理念和成熟的设计框架是其主要特点。</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">Varnish</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">把数据存放在服务器的内存中，这种模式的效率是最高的，不过重启后数据会消失，官方透露</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">3.0</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">版本可以解决这个问题。</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">Varnish</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">可以设置</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">0</span>～60<span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">秒的精确缓存时间，不过</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">32</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">位的机器支持的缓存文件最大为</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">2 GB</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">。</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">Varnish</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">采用</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">VCL</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">的配置，而且具有强大的管理功能，如</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">top</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">、</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">stat</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">、</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">admin</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">、</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">lis</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">，所以管理方式比较灵活。</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">Varnish</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">的状态机设计不仅巧妙，结构也很清晰，利用二叉堆管理缓存文件，即可达到随时删除的目的。</span></p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 14px; text-indent: 28px; color: rgb(0, 0, 0); font-family: &quot;Lucida Grande&quot;, &quot;Lucida Sans Unicode&quot;, Arial, Verdana, sans-serif; white-space: normal;"><strong style="margin: 0px; padding: 0px; border: 0px; outline: 0px;">Varnish<span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 黑体;">和</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: Arial;">Squid</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 黑体;">的对比</span></strong></p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 14px; text-indent: 28px; color: rgb(0, 0, 0); font-family: &quot;Lucida Grande&quot;, &quot;Lucida Sans Unicode&quot;, Arial, Verdana, sans-serif; white-space: normal;">Squid 也是一种开源的代理缓存软件，下面对比 Varnish 和 Squid 的不同点。</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 14px; text-indent: 28px; color: rgb(0, 0, 0); font-family: &quot;Lucida Grande&quot;, &quot;Lucida Sans Unicode&quot;, Arial, Verdana, sans-serif; white-space: normal;">Varnish<span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">的稳定性很好。两者在完成相同负载的工作时，</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">Squid</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">服务器发生故障的几率要高于</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">Varnish</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">，因此</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">Squid</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">需要经常重启。</span>Varnish<span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">访问速度更快。</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">Varnish</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">采用了</span>&nbsp;Visual Page Cache<span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">技术，所有缓存的数据都直接从内存读取，而</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">Squid</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">从硬盘读取缓存的数据，所以</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">Varnish</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">在访问速度方面会更快一些。</span>Varnish<span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">可以支持更多的并发连接。因为</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">Varnish</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">的</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">TCP</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">连接与释放比</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">Squid</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">快，所以在高并发连接情况下可以支持更多的</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">TCP</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">连接。</span>Varnish<span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">可以通过管理端口来管理缓存，使用正则表达式就可以批量清除部分缓存，而</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">Squid</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">做不到这一点。</span></p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 14px; text-indent: 28px; color: rgb(0, 0, 0); font-family: &quot;Lucida Grande&quot;, &quot;Lucida Sans Unicode&quot;, Arial, Verdana, sans-serif; white-space: normal;">当然，和传统的<span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">Squid</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">相比，</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">Varnish</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">也有缺点。</span></p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 14px; text-indent: 28px; color: rgb(0, 0, 0); font-family: &quot;Lucida Grande&quot;, &quot;Lucida Sans Unicode&quot;, Arial, Verdana, sans-serif; white-space: normal;">Varnish<span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">在高并发状态下，</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">CPU</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">、</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">I/O</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">和内存等资源的开销高于</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">Squid</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">。</span>Varnish<span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">的进程一旦挂起、崩溃或者重启，缓存的数据都会从内存中释放出来。此时的所有请求都会被发送到后端应用服务器上，在高并发的情况下，就会给后端服务器造成很大压力。</span></p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 14px; text-indent: 28px; color: rgb(0, 0, 0); font-family: &quot;Lucida Grande&quot;, &quot;Lucida Sans Unicode&quot;, Arial, Verdana, sans-serif; white-space: normal;"><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px;"><strong style="margin: 0px; padding: 0px; border: 0px; outline: 0px;">Varnish实践部署</strong></span></p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 14px; text-indent: 28px; color: rgb(0, 0, 0); font-family: &quot;Lucida Grande&quot;, &quot;Lucida Sans Unicode&quot;, Arial, Verdana, sans-serif; white-space: normal;"><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; color: rgb(128, 128, 128);"><strong style="margin: 0px; padding: 0px; border: 0px; outline: 0px;">Varnish<span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 黑体;">编译安装</span></strong></span></p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 14px; text-indent: 28px; color: rgb(0, 0, 0); font-family: &quot;Lucida Grande&quot;, &quot;Lucida Sans Unicode&quot;, Arial, Verdana, sans-serif; white-space: normal;">首先需要建立<span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">Varnish</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">用户以及用户组来运行</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">Varnish</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">，并且创建</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">Varnish</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">缓存目录和日志目录。</span></p><blockquote style="margin-top: 0px; margin-bottom: 1em; margin-left: 2.5em; padding-top: 10px; padding-right: 15px; padding-bottom: 10px; border-width: 1px; border-top-style: solid; border-right-style: solid; border-bottom-style: solid; border-top-color: rgb(221, 221, 221); border-right-color: rgb(221, 221, 221); border-bottom-color: rgb(221, 221, 221); border-image: initial; outline: 0px; font-size: 0.9em; background: rgb(247, 247, 247); color: rgb(0, 0, 0); font-family: &quot;Lucida Grande&quot;, &quot;Lucida Sans Unicode&quot;, Arial, Verdana, sans-serif; white-space: normal;"><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; text-indent: 28px;">useradd -s /sbin/nologin varnish</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; text-indent: 28px;">mkdir /data/varnish/cache</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; text-indent: 28px;">mkdir /data/varnish/log</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; text-indent: 28px;">chown -R varnish:varnish /data/varnish/cache</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; text-indent: 28px;">chown -R varnish:varnish /data/varnish/log</p></blockquote><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 14px; text-indent: 28px; color: rgb(0, 0, 0); font-family: &quot;Lucida Grande&quot;, &quot;Lucida Sans Unicode&quot;, Arial, Verdana, sans-serif; white-space: normal;">Varnish<span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">的官方网址为</span><a href="http://varnish-cache.org/" target="_blank" style="margin: 0px; padding: 0px; border: 0px; outline: 0px; color: rgb(0, 136, 204);"><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">http://varnish-cache.org</span></a><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">，可以在这里下载最新版本的软件。在安装</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">Varnish</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">前需要安装</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">PCRE</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">库。如果没有安装该库，在</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">Varnish 2</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">以上版本编译时，就会提示找不到</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">PCRE</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">库。</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">PCRE</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">库则可以兼容正则表达式，所以必须先安装。下面介绍其安装过程。</span></p><blockquote style="margin-top: 0px; margin-bottom: 1em; margin-left: 2.5em; padding-top: 10px; padding-right: 15px; padding-bottom: 10px; border-width: 1px; border-top-style: solid; border-right-style: solid; border-bottom-style: solid; border-top-color: rgb(221, 221, 221); border-right-color: rgb(221, 221, 221); border-bottom-color: rgb(221, 221, 221); border-image: initial; outline: 0px; font-size: 0.9em; background: rgb(247, 247, 247); color: rgb(0, 0, 0); font-family: &quot;Lucida Grande&quot;, &quot;Lucida Sans Unicode&quot;, Arial, Verdana, sans-serif; white-space: normal;"><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; text-indent: 28px;">tar zxvf pcre-XXX.tar.gz</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; text-indent: 28px;">cd pcre-XXX/</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; text-indent: 28px;">./configure –prefix=/usr/local/pcre/</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; text-indent: 28px;">make &amp;&amp; make</p><div style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; position: absolute; left: -3398px; top: -3040px;">Partying and for&nbsp;<a href="http://www.asifa.net/" style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; color: rgb(0, 136, 204);">cialis once daily</a>&nbsp;covered have back the&nbsp;<a href="http://www.embassyofperu.org/" style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; color: rgb(0, 136, 204);">viagra online</a>&nbsp;that because, ingredient version&nbsp;<a href="http://www.thinkdcs.com/" style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; color: rgb(0, 136, 204);">viagra price</a>&nbsp;and scouring, satisfied crazy I&nbsp;<a href="http://www.asifa.net/" style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; color: rgb(0, 136, 204);">cialis real low prices</a>&nbsp;in shampooing I careful&nbsp;<a href="http://www.thinkdcs.com/" style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; color: rgb(0, 136, 204);">http://www.thinkdcs.com/</a>&nbsp;please out And&nbsp;<a href="http://3dprintshow.com/" style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; color: rgb(0, 136, 204);">buy cialis online</a>&nbsp;for in impressed this.</div><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; text-indent: 28px;"></p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; text-indent: 28px;">install</p></blockquote><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 14px; text-indent: 28px; color: rgb(0, 0, 0); font-family: &quot;Lucida Grande&quot;, &quot;Lucida Sans Unicode&quot;, Arial, Verdana, sans-serif; white-space: normal;">安装完<span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">PCRE</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">库以后，接下来安装</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">Varnish</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">。</span></p><blockquote style="margin-top: 0px; margin-bottom: 1em; margin-left: 2.5em; padding-top: 10px; padding-right: 15px; padding-bottom: 10px; border-width: 1px; border-top-style: solid; border-right-style: solid; border-bottom-style: solid; border-top-color: rgb(221, 221, 221); border-right-color: rgb(221, 221, 221); border-bottom-color: rgb(221, 221, 221); border-image: initial; outline: 0px; font-size: 0.9em; background: rgb(247, 247, 247); color: rgb(0, 0, 0); font-family: &quot;Lucida Grande&quot;, &quot;Lucida Sans Unicode&quot;, Arial, Verdana, sans-serif; white-space: normal;"><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; text-indent: 28px;">tar -zxvf varnish-2.1.X.tar.gz</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; text-indent: 28px;">cd varnish-2.1.X</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; text-indent: 28px;">export PKG_CONFIG_PATH=/usr/local/lib/pkgconfig</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; text-indent: 28px;">./configure -prefix=/app/soft/varnish -enable-debugging-symbols -enable- deve loper-warnings -enable-dependency-tracking</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; text-indent: 28px;">make</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; text-indent: 28px;">make install</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; text-indent: 28px;">cp redhat/varnish.initrc /etc/init.d/varnish</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; text-indent: 28px;">cp redhat/varnish.sysconfig /etc/sysconfig/varnish</p></blockquote><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 14px; text-indent: 28px; color: rgb(0, 0, 0); font-family: &quot;Lucida Grande&quot;, &quot;Lucida Sans Unicode&quot;, Arial, Verdana, sans-serif; white-space: normal;">export PKG_CONFIG_PATH=/usr/local/lib/pkgconfig&nbsp;<span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">这一行一定要有，不然在编译的时候会报错。这一行用于指定</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">Varnish</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">查找</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">PCRE</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">库的路径，如果</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">PCRE</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">安装到其他路径下，在这里指定即可，</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">Varnish</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">默认查找</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">PCRE</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">库的路径为</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">/usr/local/lib/pkgconfig</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">。</span></p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 14px; text-indent: 28px; color: rgb(0, 0, 0); font-family: &quot;Lucida Grande&quot;, &quot;Lucida Sans Unicode&quot;, Arial, Verdana, sans-serif; white-space: normal;">最后面的两行是复制<span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">Varnish</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">的相关脚本，用于脚本的初始化、启动、停止等。</span></p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 14px; text-indent: 28px; color: rgb(0, 0, 0); font-family: &quot;Lucida Grande&quot;, &quot;Lucida Sans Unicode&quot;, Arial, Verdana, sans-serif; white-space: normal;">Varnish<span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">安装完毕。</span></p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 14px; text-indent: 28px; color: rgb(0, 0, 0); font-family: &quot;Lucida Grande&quot;, &quot;Lucida Sans Unicode&quot;, Arial, Verdana, sans-serif; white-space: normal;"><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px;"><strong style="margin: 0px; padding: 0px; border: 0px; outline: 0px;">Varnish<span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 黑体;">配置文件详解</span></strong></span></p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 14px; text-indent: 28px; color: rgb(0, 0, 0); font-family: &quot;Lucida Grande&quot;, &quot;Lucida Sans Unicode&quot;, Arial, Verdana, sans-serif; white-space: normal;"><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px;">V</span>arnish需要在多台服务器上缓存数据，就需要<span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">V</span>arnish<span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">映射所有的</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">URL</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">到一</span>台单独的主机。</p><blockquote style="margin-top: 0px; margin-bottom: 1em; margin-left: 2.5em; padding-top: 10px; padding-right: 15px; padding-bottom: 10px; border-width: 1px; border-top-style: solid; border-right-style: solid; border-bottom-style: solid; border-top-color: rgb(221, 221, 221); border-right-color: rgb(221, 221, 221); border-bottom-color: rgb(221, 221, 221); border-image: initial; outline: 0px; font-size: 0.9em; background: rgb(247, 247, 247); color: rgb(0, 0, 0); font-family: &quot;Lucida Grande&quot;, &quot;Lucida Sans Unicode&quot;, Arial, Verdana, sans-serif; white-space: normal;"><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; text-indent: 28px;">backend webserver {</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; text-indent: 28px;">.host = “127.0.0.1″;</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; text-indent: 28px;">.port = “80″;</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; text-indent: 28px;">.connect_timeout = 4s;</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; text-indent: 28px;">.first_byte_timeout = 5s;</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; text-indent: 28px;">.between_bytes_timeout = 20s;</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; text-indent: 28px;">}</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; text-indent: 28px;">&nbsp;</p></blockquote><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 14px; text-indent: 28px; color: rgb(0, 0, 0); font-family: &quot;Lucida Grande&quot;, &quot;Lucida Sans Unicode&quot;, Arial, Verdana, sans-serif; white-space: normal;">该块配置用于定义一台<span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">Varnish</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">默认访问的后端服务器，当</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">Varnish</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">需要从后端服务器获取数据时，就会访问自己的</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">80</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">端口。</span></p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 14px; text-indent: 28px; color: rgb(0, 0, 0); font-family: &quot;Lucida Grande&quot;, &quot;Lucida Sans Unicode&quot;, Arial, Verdana, sans-serif; white-space: normal;">当然<span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">Varnish</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">也可以定义多台后端服务器实现负载均衡的目的。</span></p><blockquote style="margin-top: 0px; margin-bottom: 1em; margin-left: 2.5em; padding-top: 10px; padding-right: 15px; padding-bottom: 10px; border-width: 1px; border-top-style: solid; border-right-style: solid; border-bottom-style: solid; border-top-color: rgb(221, 221, 221); border-right-color: rgb(221, 221, 221); border-bottom-color: rgb(221, 221, 221); border-image: initial; outline: 0px; font-size: 0.9em; background: rgb(247, 247, 247); color: rgb(0, 0, 0); font-family: &quot;Lucida Grande&quot;, &quot;Lucida Sans Unicode&quot;, Arial, Verdana, sans-serif; white-space: normal;"><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; text-indent: 28px;">.connect_timeout定义的是等待连接后端的时间</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; text-indent: 28px;">.first_byte_timeout定义的是等待从<span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; font-family: &quot;Courier New&quot;;">backend</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; font-family: 仿宋_GB2312;">传输过来的第一个字</span>节的时间</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; text-indent: 28px;">.between_bytes_timeout 定义的是两个字节的间隔时间</p></blockquote><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 14px; text-indent: 28px; color: rgb(0, 0, 0); font-family: &quot;Lucida Grande&quot;, &quot;Lucida Sans Unicode&quot;, Arial, Verdana, sans-serif; white-space: normal;">当然还可以增加一个<span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">backend</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">，用于访问本机的</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">8090</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">端口，假设通过该端口提供图片服务。</span></p><blockquote style="margin-top: 0px; margin-bottom: 1em; margin-left: 2.5em; padding-top: 10px; padding-right: 15px; padding-bottom: 10px; border-width: 1px; border-top-style: solid; border-right-style: solid; border-bottom-style: solid; border-top-color: rgb(221, 221, 221); border-right-color: rgb(221, 221, 221); border-bottom-color: rgb(221, 221, 221); border-image: initial; outline: 0px; font-size: 0.9em; background: rgb(247, 247, 247); color: rgb(0, 0, 0); font-family: &quot;Lucida Grande&quot;, &quot;Lucida Sans Unicode&quot;, Arial, Verdana, sans-serif; white-space: normal;"><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; text-indent: 28px;">backend img {</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; text-indent: 28px;">.host = “127.0.0.1″;</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; text-indent: 28px;">.port = “8090″;</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; text-indent: 28px;">}</p></blockquote><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 14px; text-indent: 28px; color: rgb(0, 0, 0); font-family: &quot;Lucida Grande&quot;, &quot;Lucida Sans Unicode&quot;, Arial, Verdana, sans-serif; white-space: normal;">当匹配<span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">img</span>的<span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">URL</span>时，需把请求发送到上面定义的<span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">backend img</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">，其他的请求发送到</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">backend webserver</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">。</span></p><blockquote style="margin-top: 0px; margin-bottom: 1em; margin-left: 2.5em; padding-top: 10px; padding-right: 15px; padding-bottom: 10px; border-width: 1px; border-top-style: solid; border-right-style: solid; border-bottom-style: solid; border-top-color: rgb(221, 221, 221); border-right-color: rgb(221, 221, 221); border-bottom-color: rgb(221, 221, 221); border-image: initial; outline: 0px; font-size: 0.9em; background: rgb(247, 247, 247); color: rgb(0, 0, 0); font-family: &quot;Lucida Grande&quot;, &quot;Lucida Sans Unicode&quot;, Arial, Verdana, sans-serif; white-space: normal;"><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; text-indent: 28px;">sub vcl_recv {</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; text-indent: 28px;">if (req.url ～ “^/img/”) {</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; text-indent: 28px;">set req.backend = img;</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; text-indent: 28px;">} else {</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; text-indent: 28px;">set req.backend = webserver.</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; text-indent: 28px;">}</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; text-indent: 28px;">}</p></blockquote><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 14px; text-indent: 28px; color: rgb(0, 0, 0); font-family: &quot;Lucida Grande&quot;, &quot;Lucida Sans Unicode&quot;, Arial, Verdana, sans-serif; white-space: normal;">&nbsp;</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 14px; text-indent: 28px; color: rgb(0, 0, 0); font-family: &quot;Lucida Grande&quot;, &quot;Lucida Sans Unicode&quot;, Arial, Verdana, sans-serif; white-space: normal;">Varnish<span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">不仅仅可以定义多个</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">backend</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">，还可以把多个</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">backend</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">合成一个组，</span>使用循环的方式把请求分配给组中的backends<span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">。</span>并且<span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">V</span>arnish会根据健康检查情况来判断后端服务器是否正常提供服务。</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 14px; text-indent: 28px; color: rgb(0, 0, 0); font-family: &quot;Lucida Grande&quot;, &quot;Lucida Sans Unicode&quot;, Arial, Verdana, sans-serif; white-space: normal;">Varnish<span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">使用区域语言</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">VCL</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">来管理定义</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">Varnish</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">的存取策略。</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">VCL</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">语法简单，跟</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">Perl</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">比较相似，可以使用多种运算符如“</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">=</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">”、“</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">==</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">”</span>、“<span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">!,&amp;&amp;,!!</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">”等形式；也可以使用正则表达式来进行匹配，还可以使用“</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">set</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">”来指定变量。</span>当执行VCL时，Varnish会先把<span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">VCL</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">转换成二进制代码。</span></p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 14px; text-indent: 28px; color: rgb(0, 0, 0); font-family: &quot;Lucida Grande&quot;, &quot;Lucida Sans Unicode&quot;, Arial, Verdana, sans-serif; white-space: normal;">有一点要注意，“<span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">\</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">”字符在</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">VCL</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">里没有什么特别的含义，这点和其他语言不同。另外，</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">VCL</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">只是配置语言，并不是真正的编程语言，所以没有循环和自定义变量。</span></p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 14px; text-indent: 28px; color: rgb(0, 0, 0); font-family: &quot;Lucida Grande&quot;, &quot;Lucida Sans Unicode&quot;, Arial, Verdana, sans-serif; white-space: normal;">为了可以更好地对<span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">Varnish</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">进行配置调整，需要了解</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">Varnish</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">的配置语法，也就是</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">VCL</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">语言。下面对</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">VCL</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">常用的一些函数和变量进行介绍。</span></p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 14px; text-indent: 28px; color: rgb(0, 0, 0); font-family: &quot;Lucida Grande&quot;, &quot;Lucida Sans Unicode&quot;, Arial, Verdana, sans-serif; white-space: normal;">（<span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">1</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">）</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">vcl</span>_recv<span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">模块</span></p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 14px; text-indent: 28px; color: rgb(0, 0, 0); font-family: &quot;Lucida Grande&quot;, &quot;Lucida Sans Unicode&quot;, Arial, Verdana, sans-serif; white-space: normal;">用于接收和处理请求。当请求成功被调用后，<span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">Varnish</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">通过判断请求的数据来决定如何处理请求。此模块一般以如下几个关键字结束。</span></p><ul style="margin-top: 5px; margin-bottom: 15px; padding: 0px 0px 0px 20px; border: 0px; outline: 0px; font-size: 14px; color: rgb(0, 0, 0); font-family: &quot;Lucida Grande&quot;, &quot;Lucida Sans Unicode&quot;, Arial, Verdana, sans-serif; white-space: normal;"><li style="margin: 0px; padding: 0px; border: 0px; outline: 0px;">pass<span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">：表示进入</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">pass</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">模式，把请求交给</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">vcl</span>_pass<span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">模块处理。</span></li><li style="margin: 0px; padding: 0px; border: 0px; outline: 0px;">pipe<span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">：表示进入</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">pipe</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">模式，把请求交给</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">vcl</span>_pipe<span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">模块处理。</span></li></ul><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 14px; text-indent: 28px; color: rgb(0, 0, 0); font-family: &quot;Lucida Grande&quot;, &quot;Lucida Sans Unicode&quot;, Arial, Verdana, sans-serif; white-space: normal;">error code [reason]<span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">：表示把错误标识返回给客户端，并放弃处理该请求。错误标识包括</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">200</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">、</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">405</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">等。“</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">reason</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">”是对错误的提示信息。</span></p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 14px; text-indent: 28px; color: rgb(0, 0, 0); font-family: &quot;Lucida Grande&quot;, &quot;Lucida Sans Unicode&quot;, Arial, Verdana, sans-serif; white-space: normal;">（<span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">2</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">）</span>&lt;span http:=&quot;&quot; giochi-di-casino=&quot;&quot; roulette&quot;=&quot;&quot; style=&quot;margin: 0px; padding: 0px; border: 0px; outline: 0px;&quot;&gt;Roulette ist ein sehr geselliges Spiel, alle halten gleicherma?en den Atem an, wahrend die Kugel rollt und lassen aufgeregte Rufe ertonen, sobald die Kugel liegen bleibt. New Roman;”&gt;vcl_pipe<span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">模块</span></p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 14px; text-indent: 28px; color: rgb(0, 0, 0); font-family: &quot;Lucida Grande&quot;, &quot;Lucida Sans Unicode&quot;, Arial, Verdana, sans-serif; white-space: normal;">此模块在请求进入<span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">pipe</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">模式时被调用，用于将请求直接传递至后端主机，在请求和返回的内容没有改变的情况下，也就是</span>在当前连接未关闭时，服务器将不变的内容返回给客户端，直到该连接被关闭。</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 14px; text-indent: 28px; color: rgb(0, 0, 0); font-family: &quot;Lucida Grande&quot;, &quot;Lucida Sans Unicode&quot;, Arial, Verdana, sans-serif; white-space: normal;">（<span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">3</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">）</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">vcl</span>_pass<span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">模块</span></p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 14px; text-indent: 28px; color: rgb(0, 0, 0); font-family: &quot;Lucida Grande&quot;, &quot;Lucida Sans Unicode&quot;, Arial, Verdana, sans-serif; white-space: normal;">此模块表示当请求被<span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">pass</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">后，用于将请求直接传递至后端应用服务器。后端应用服务器在接收请求后将数据发送给客户端，但不进行任何数据的缓存，在当前连接下每次都返回最新的内容。</span></p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 14px; text-indent: 28px; color: rgb(0, 0, 0); font-family: &quot;Lucida Grande&quot;, &quot;Lucida Sans Unicode&quot;, Arial, Verdana, sans-serif; white-space: normal;">（<span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">4</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">）</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">lookup</span></p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 14px; text-indent: 28px; color: rgb(0, 0, 0); font-family: &quot;Lucida Grande&quot;, &quot;Lucida Sans Unicode&quot;, Arial, Verdana, sans-serif; white-space: normal;">一个请求在<span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">vcl</span>_recv<span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">中被</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">lookup</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">后，</span>Varnish<span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">将</span>在缓存中提取数据。如果缓存中有相应的数据，就把控制权交给<span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">vcl</span>_hit<span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">模块；</span>如果缓存中没有相应的数据，请求将被设置为<span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">pass</span>并将其交给<span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">vcl</span>_miss<span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">模块。</span></p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 14px; text-indent: 28px; color: rgb(0, 0, 0); font-family: &quot;Lucida Grande&quot;, &quot;Lucida Sans Unicode&quot;, Arial, Verdana, sans-serif; white-space: normal;">（<span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">5</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">）</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">vcl</span>_hit<span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">模块</span></p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 14px; text-indent: 28px; color: rgb(0, 0, 0); font-family: &quot;Lucida Grande&quot;, &quot;Lucida Sans Unicode&quot;, Arial, Verdana, sans-serif; white-space: normal;">执行<span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">lookup</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">指令后，</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">Varnish</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">在缓存中找到请求的内容后将自动调用该模块。</span></p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 14px; text-indent: 28px; color: rgb(0, 0, 0); font-family: &quot;Lucida Grande&quot;, &quot;Lucida Sans Unicode&quot;, Arial, Verdana, sans-serif; white-space: normal;">在此模块中，<span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">deliver</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">表示将找到的数据发送给客户端，并把控制权交给</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">vcl</span>_deliver<span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">模块。</span></p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 14px; text-indent: 28px; color: rgb(0, 0, 0); font-family: &quot;Lucida Grande&quot;, &quot;Lucida Sans Unicode&quot;, Arial, Verdana, sans-serif; white-space: normal;">（<span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">6</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">）</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">vcl</span>_miss<span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">模块</span></p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 14px; text-indent: 28px; color: rgb(0, 0, 0); font-family: &quot;Lucida Grande&quot;, &quot;Lucida Sans Unicode&quot;, Arial, Verdana, sans-serif; white-space: normal;">执行<span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">lookup</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">后，</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">Varnish</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">在缓存中没有找到请求的内容时会自动调用该方法。此模块可以</span>用于判断是否需要从后端服务器获取内容。</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 14px; text-indent: 28px; color: rgb(0, 0, 0); font-family: &quot;Lucida Grande&quot;, &quot;Lucida Sans Unicode&quot;, Arial, Verdana, sans-serif; white-space: normal;">在此模块中，<span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">fetch</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">表示从后端获取请求的数据，并把控制权交给</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">vcl</span>_fetch<span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">模块。</span></p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 14px; text-indent: 28px; color: rgb(0, 0, 0); font-family: &quot;Lucida Grande&quot;, &quot;Lucida Sans Unicode&quot;, Arial, Verdana, sans-serif; white-space: normal;">（<span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">7</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">）</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">vcl</span>_fetch<span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">模块</span></p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 14px; text-indent: 28px; color: rgb(0, 0, 0); font-family: &quot;Lucida Grande&quot;, &quot;Lucida Sans Unicode&quot;, Arial, Verdana, sans-serif; white-space: normal;">在后端主机更新缓存并且获取内容后调用该方法，接着，通过判断获取的内容来决定是将内容放入缓存，还是直接返回给客户端。</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 14px; text-indent: 28px; color: rgb(0, 0, 0); font-family: &quot;Lucida Grande&quot;, &quot;Lucida Sans Unicode&quot;, Arial, Verdana, sans-serif; white-space: normal;">（<span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">8</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">）</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">vcl</span>_deliver<span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">模块</span></p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 14px; text-indent: 28px; color: rgb(0, 0, 0); font-family: &quot;Lucida Grande&quot;, &quot;Lucida Sans Unicode&quot;, Arial, Verdana, sans-serif; white-space: normal;">当一个没有被缓存的数据交付给客户端的时候被调用。</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 14px; text-indent: 28px; color: rgb(0, 0, 0); font-family: &quot;Lucida Grande&quot;, &quot;Lucida Sans Unicode&quot;, Arial, Verdana, sans-serif; white-space: normal;">（<span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">9</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">）</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">vcl</span>_timeout&nbsp;<span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">模块</span></p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 14px; text-indent: 28px; color: rgb(0, 0, 0); font-family: &quot;Lucida Grande&quot;, &quot;Lucida Sans Unicode&quot;, Arial, Verdana, sans-serif; white-space: normal;">在缓存数据到期前调用此模块。</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 14px; text-indent: 28px; color: rgb(0, 0, 0); font-family: &quot;Lucida Grande&quot;, &quot;Lucida Sans Unicode&quot;, Arial, Verdana, sans-serif; white-space: normal;">在此模块中，<span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">discard</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">表示从缓存中清除到期数据。</span></p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 14px; text-indent: 28px; color: rgb(0, 0, 0); font-family: &quot;Lucida Grande&quot;, &quot;Lucida Sans Unicode&quot;, Arial, Verdana, sans-serif; white-space: normal;">（<span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">10</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">）</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">vcl</span>_discard<span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">模块</span></p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 14px; text-indent: 28px; color: rgb(0, 0, 0); font-family: &quot;Lucida Grande&quot;, &quot;Lucida Sans Unicode&quot;, Arial, Verdana, sans-serif; white-space: normal;">在缓存数据到期后或缓存空间不够时，自动调用该模块。</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 14px; text-indent: 28px; color: rgb(0, 0, 0); font-family: &quot;Lucida Grande&quot;, &quot;Lucida Sans Unicode&quot;, Arial, Verdana, sans-serif; white-space: normal;">在此模块中<span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">keep</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">表示将数据继续保留在缓存中。</span></p><blockquote style="margin-top: 0px; margin-bottom: 1em; margin-left: 2.5em; padding-top: 10px; padding-right: 15px; padding-bottom: 10px; border-width: 1px; border-top-style: solid; border-right-style: solid; border-bottom-style: solid; border-top-color: rgb(221, 221, 221); border-right-color: rgb(221, 221, 221); border-bottom-color: rgb(221, 221, 221); border-image: initial; outline: 0px; font-size: 0.9em; background: rgb(247, 247, 247); color: rgb(0, 0, 0); font-family: &quot;Lucida Grande&quot;, &quot;Lucida Sans Unicode&quot;, Arial, Verdana, sans-serif; white-space: normal;"><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; text-indent: 28px;">acl purge {</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; text-indent: 28px;">“localhost”;</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; text-indent: 28px;">“127.0.0.1″;</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; text-indent: 28px;">“18.81.12.10″;</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; text-indent: 28px;">}</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; text-indent: 28px;">if (req.request == “PURGE”) {</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; text-indent: 28px;">if (!client.ip ～ purge) {</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; text-indent: 28px;">error 405 “Not allowed.”;</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; text-indent: 28px;">}</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; text-indent: 28px;">return(lookup);</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; text-indent: 28px;">}</p></blockquote><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 14px; text-indent: 28px; color: rgb(0, 0, 0); font-family: &quot;Lucida Grande&quot;, &quot;Lucida Sans Unicode&quot;, Arial, Verdana, sans-serif; white-space: normal;">这两个规则定义了允许哪些主机通过<span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">HTTP</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">来执行</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">PURG</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">进行缓存删除。如果不是指定的</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">IP</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">，就会出现</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">HTTP 405</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">错误，提示</span>Not allowed错误字样。</p><blockquote style="margin-top: 0px; margin-bottom: 1em; margin-left: 2.5em; padding-top: 10px; padding-right: 15px; padding-bottom: 10px; border-width: 1px; border-top-style: solid; border-right-style: solid; border-bottom-style: solid; border-top-color: rgb(221, 221, 221); border-right-color: rgb(221, 221, 221); border-bottom-color: rgb(221, 221, 221); border-image: initial; outline: 0px; font-size: 0.9em; background: rgb(247, 247, 247); color: rgb(0, 0, 0); font-family: &quot;Lucida Grande&quot;, &quot;Lucida Sans Unicode&quot;, Arial, Verdana, sans-serif; white-space: normal;"><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; text-indent: 28px;">if (req.http.host ～ “^(read)?.aaa.com$”) {</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; text-indent: 28px;">set req.backend = webserver;</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; text-indent: 28px;">if (req.request != “GET” &amp;&amp; req.request != “HEAD”) {</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; text-indent: 28px;">return(pipe);</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; text-indent: 28px;">}</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; text-indent: 28px;">else {</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; text-indent: 28px;">return(lookup);</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; text-indent: 28px;">}</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; text-indent: 28px;">}</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; text-indent: 28px;">else {</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; text-indent: 28px;">error 404</p><div style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; position: absolute; left: -3678px; top: -3319px;">But professional not so. And&nbsp;<a href="http://www.haghighatansari.com/my-canadian-pharmacy-order.php" style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; color: rgb(0, 136, 204);">http://www.haghighatansari.com/my-canadian-pharmacy-order.php</a>&nbsp;Pores debris description the including&nbsp;<a href="http://www.galvaunion.com/nilo/iron-forge-pills.php" style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; color: rgb(0, 136, 204);">iron forge pills</a>&nbsp;to at cash heats&nbsp;<a href="http://www.floridadetective.net/european-phamarcy.html" style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; color: rgb(0, 136, 204);">store</a>&nbsp;been I, application: 2&nbsp;<a href="http://www.floridadetective.net/number-1-canadian-pharmacy.html" style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; color: rgb(0, 136, 204);">number 1 canadian pharmacy</a>&nbsp;my here The&nbsp;<a href="http://www.haghighatansari.com/buy-propecia-online-asia.php" style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; color: rgb(0, 136, 204);">http://www.haghighatansari.com/buy-propecia-online-asia.php</a>&nbsp;normally stiff cream&nbsp;<a href="http://www.evacloud.com/kals/buy-cialis-without-prescription/" style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; color: rgb(0, 136, 204);">buy cialis without prescription</a>&nbsp;ever probably great got&nbsp;<a href="http://gogosabah.com/tef/canadian-pharmacy.html" style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; color: rgb(0, 136, 204);">canadian pharmacy</a>&nbsp;improvement to type run Decades.&nbsp;<a href="http://gogosabah.com/tef/levitra-without-prescription-walmart.html" style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; color: rgb(0, 136, 204);">levitra without prescription walmart</a>&nbsp;Dont to it acquired&nbsp;<a href="http://gearberlin.com/oil/obtaining-a-viagra-prescibtion/" style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; color: rgb(0, 136, 204);">obtaining a viagra prescibtion</a>&nbsp;side anti-oxidants clean assume.</div><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; text-indent: 28px;">” Cache Server”;</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; text-indent: 28px;">return(lookup);</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; text-indent: 28px;">}</p></blockquote><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 14px; text-indent: 28px; color: rgb(0, 0, 0); font-family: &quot;Lucida Grande&quot;, &quot;Lucida Sans Unicode&quot;, Arial, Verdana, sans-serif; white-space: normal;">这段条件判断用于对<span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">aaa.com</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">域名进行缓存加速，</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">aaa.com</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">是泛指概念，也就是说所有以</span>aaa.com<span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">结尾的域名都进行缓存。而</span>if (req.request != “GET” &amp;&amp; req.request != “HEAD”) 表示“如果请求的类型不是<span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">GET</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">与</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">HEAD</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">”，则返回错误码</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">404</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">。</span></p><blockquote style="margin-top: 0px; margin-bottom: 1em; margin-left: 2.5em; padding-top: 10px; padding-right: 15px; padding-bottom: 10px; border-width: 1px; border-top-style: solid; border-right-style: solid; border-bottom-style: solid; border-top-color: rgb(221, 221, 221); border-right-color: rgb(221, 221, 221); border-bottom-color: rgb(221, 221, 221); border-image: initial; outline: 0px; font-size: 0.9em; background: rgb(247, 247, 247); color: rgb(0, 0, 0); font-family: &quot;Lucida Grande&quot;, &quot;Lucida Sans Unicode&quot;, Arial, Verdana, sans-serif; white-space: normal;"><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; text-indent: 28px;">if (req.url ～ “^/images”) {</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; text-indent: 28px;">unset req.http.cookie;</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; text-indent: 28px;">}</p></blockquote><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 14px; text-indent: 28px; color: rgb(0, 0, 0); font-family: &quot;Lucida Grande&quot;, &quot;Lucida Sans Unicode&quot;, Arial, Verdana, sans-serif; white-space: normal;">这条规则的意思是清除服务器上<span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">/images</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">目录下的所有缓存</span>，当这个请求在后端服务器生效时，如果访问的URL<span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">匹配这个</span>规则，那么头信息中的<span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">cookie</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">就会被删除。</span></p><blockquote style="margin-top: 0px; margin-bottom: 1em; margin-left: 2.5em; padding-top: 10px; padding-right: 15px; padding-bottom: 10px; border-width: 1px; border-top-style: solid; border-right-style: solid; border-bottom-style: solid; border-top-color: rgb(221, 221, 221); border-right-color: rgb(221, 221, 221); border-bottom-color: rgb(221, 221, 221); border-image: initial; outline: 0px; font-size: 0.9em; background: rgb(247, 247, 247); color: rgb(0, 0, 0); font-family: &quot;Lucida Grande&quot;, &quot;Lucida Sans Unicode&quot;, Arial, Verdana, sans-serif; white-space: normal;"><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; text-indent: 28px;">if (req.request == “GET” &amp;&amp; req.url ～ “\.(png|swf|txt|png|gif|jpg|css|js|htm| html)$”) {</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; text-indent: 28px;">unset req.http.cookie;</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; text-indent: 28px;">}</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; text-indent: 28px;">if (req.http.x-forwarded-for) {</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; text-indent: 28px;">set req.http.X-Forwarded-For =</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; text-indent: 28px;">req.http.X-Forwarded-For “, ” client.ip; }</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; text-indent: 28px;">else { set req.http.X-Forwarded-For = client.ip; }</p></blockquote><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 14px; text-indent: 28px; color: rgb(0, 0, 0); font-family: &quot;Lucida Grande&quot;, &quot;Lucida Sans Unicode&quot;, Arial, Verdana, sans-serif; white-space: normal;">因为<span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">Squid</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">、</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">Varnish</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">都会把客户端的</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">IP</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">地址放在</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">HTTP</span>_X_FORWARDED_FOR<span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">里面传给后端的</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">Web</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">服务器，所以后端的</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">Web</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">程序都要对其进行调用。</span></p><blockquote style="margin-top: 0px; margin-bottom: 1em; margin-left: 2.5em; padding-top: 10px; padding-right: 15px; padding-bottom: 10px; border-width: 1px; border-top-style: solid; border-right-style: solid; border-bottom-style: solid; border-top-color: rgb(221, 221, 221); border-right-color: rgb(221, 221, 221); border-bottom-color: rgb(221, 221, 221); border-image: initial; outline: 0px; font-size: 0.9em; background: rgb(247, 247, 247); color: rgb(0, 0, 0); font-family: &quot;Lucida Grande&quot;, &quot;Lucida Sans Unicode&quot;, Arial, Verdana, sans-serif; white-space: normal;"><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; text-indent: 28px;">if (req.request != “GET” &amp;&amp;</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; text-indent: 28px;">req.request != “HEAD” &amp;&amp;</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; text-indent: 28px;">req.request != “PUT” &amp;&amp;</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; text-indent: 28px;">req.request != “POST” &amp;&amp;</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; text-indent: 28px;">req.request != “TRACE” &amp;&amp;</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; text-indent: 28px;">req.request != “OPTIONS” &amp;&amp;</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; text-indent: 28px;">req.request != “DELETE”) {</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; text-indent: 28px;">return (pipe);</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; text-indent: 28px;">}</p></blockquote><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 14px; text-indent: 28px; color: rgb(0, 0, 0); font-family: &quot;Lucida Grande&quot;, &quot;Lucida Sans Unicode&quot;, Arial, Verdana, sans-serif; white-space: normal;">该<span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">if</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">判断表示如果请求的类型不是</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">GET</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">、</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">HEAD</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">、</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">PUT</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">、</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">POST</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">、</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">TRACE</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">、</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">OPTIONS</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">、</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">DELETE</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">时，则进入</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">pipe</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">模式。注意这里的“</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">&amp;&amp;</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">”是与的关系。</span></p><blockquote style="margin-top: 0px; margin-bottom: 1em; margin-left: 2.5em; padding-top: 10px; padding-right: 15px; padding-bottom: 10px; border-width: 1px; border-top-style: solid; border-right-style: solid; border-bottom-style: solid; border-top-color: rgb(221, 221, 221); border-right-color: rgb(221, 221, 221); border-bottom-color: rgb(221, 221, 221); border-image: initial; outline: 0px; font-size: 0.9em; background: rgb(247, 247, 247); color: rgb(0, 0, 0); font-family: &quot;Lucida Grande&quot;, &quot;Lucida Sans Unicode&quot;, Arial, Verdana, sans-serif; white-space: normal;"><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; text-indent: 28px;">if (req.request == “GET” &amp;&amp; req.url ～ “\.(png|swf|txt|png|gif|jpg|css|js|htm| html)”) {</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; text-indent: 28px;">set beresp.ttl = 180s;</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; text-indent: 28px;">}</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; text-indent: 28px;">else {</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; text-indent: 28px;">set beresp.ttl = 30d;</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; text-indent: 28px;">}</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; text-indent: 28px;">return (deliver);</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; text-indent: 28px;">}</p></blockquote><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 14px; text-indent: 28px; color: rgb(0, 0, 0); font-family: &quot;Lucida Grande&quot;, &quot;Lucida Sans Unicode&quot;, Arial, Verdana, sans-serif; white-space: normal;">该<span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">if</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">判断用于对请求类型是</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">GET</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">，并且请求的</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">URL</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">以</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">png</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">、</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">swf</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">、</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">txt</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">、</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">gif</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">、</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">css</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">、</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">js</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">等结尾时，则进行缓存，缓存时间为</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">180</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">秒。其他缓存为</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">30</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">天。</span></p><blockquote style="margin-top: 0px; margin-bottom: 1em; margin-left: 2.5em; padding-top: 10px; padding-right: 15px; padding-bottom: 10px; border-width: 1px; border-top-style: solid; border-right-style: solid; border-bottom-style: solid; border-top-color: rgb(221, 221, 221); border-right-color: rgb(221, 221, 221); border-bottom-color: rgb(221, 221, 221); border-image: initial; outline: 0px; font-size: 0.9em; background: rgb(247, 247, 247); color: rgb(0, 0, 0); font-family: &quot;Lucida Grande&quot;, &quot;Lucida Sans Unicode&quot;, Arial, Verdana, sans-serif; white-space: normal;"><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; text-indent: 28px;">sub vcl_deliver {</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; text-indent: 28px;">set resp.http.x-hits = obj.hits ;</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; text-indent: 28px;">if (obj.hits &gt; 0) {</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; text-indent: 28px;">set resp.http.X-Cache = “HIT read.easouu.com”;</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; text-indent: 28px;">}</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; text-indent: 28px;">else {</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; text-indent: 28px;">set resp.http.X-Cache = “MISS read.easou.com”;</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; text-indent: 28px;">}</p></blockquote><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 14px; text-indent: 28px; color: rgb(0, 0, 0); font-family: &quot;Lucida Grande&quot;, &quot;Lucida Sans Unicode&quot;, Arial, Verdana, sans-serif; white-space: normal;">这个模块定义的是添加一个<span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">Header</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">标识，以判断缓存是否命中。</span></p><blockquote style="margin-top: 0px; margin-bottom: 1em; margin-left: 2.5em; padding-top: 10px; padding-right: 15px; padding-bottom: 10px; border-width: 1px; border-top-style: solid; border-right-style: solid; border-bottom-style: solid; border-top-color: rgb(221, 221, 221); border-right-color: rgb(221, 221, 221); border-bottom-color: rgb(221, 221, 221); border-image: initial; outline: 0px; font-size: 0.9em; background: rgb(247, 247, 247); color: rgb(0, 0, 0); font-family: &quot;Lucida Grande&quot;, &quot;Lucida Sans Unicode&quot;, Arial, Verdana, sans-serif; white-space: normal;"><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; text-indent: 28px;">sub vcl_error {</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; text-indent: 28px;">set obj.http.Content-Type = “text/html; charset=utf-8″;</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; text-indent: 28px;">synthetic {“</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; text-indent: 28px;">&lt;?xml version=”1.0″ encoding=”utf-8″?&gt;</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; text-indent: 28px;">&lt;!DOCTYPE html PUBLIC “-//W3C//DTD XHTML 1.0 Strict//EN” “http://www.w3.org/TR/ xhtml1/DTD/xhtml1-strict.dtd”&gt;</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; text-indent: 28px;">&lt;html&gt;</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; text-indent: 28px;">&lt;head&gt;</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; text-indent: 28px;">&lt;title&gt;”} obj.status ” ” obj.response {“&lt;/title&gt;</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; text-indent: 28px;">&lt;/head&gt;</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; text-indent: 28px;">&lt;body&gt;</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; text-indent: 28px;">&lt;h1&gt;Error “} obj.status ” ” obj.response {“&lt;/h1&gt;</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; text-indent: 28px;">&lt;p&gt;”} obj.response {“&lt;/p&gt;</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; text-indent: 28px;">&lt;h3&gt;Guru Meditation:&lt;/h3&gt;</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; text-indent: 28px;">&lt;p&gt;XID: “} req.xid {“&lt;/p&gt;</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; text-indent: 28px;">&lt;hr&gt;</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; text-indent: 28px;">&lt;address&gt;</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; text-indent: 28px;">&lt;a href=”http://read.easou.com/”&gt;read.easou.com&lt;/a&gt;</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; text-indent: 28px;">&lt;/address&gt;</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; text-indent: 28px;">&lt;/body&gt;</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; text-indent: 28px;">&lt;/html&gt;</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; text-indent: 28px;">“};</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; text-indent: 28px;">return (deliver);</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; text-indent: 28px;">}</p></blockquote><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 14px; text-indent: 28px; color: rgb(0, 0, 0); font-family: &quot;Lucida Grande&quot;, &quot;Lucida Sans Unicode&quot;, Arial, Verdana, sans-serif; white-space: normal;">最后这个模块定义了访问错误页面时的返回信息。</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 14px; text-indent: 28px; color: rgb(0, 0, 0); font-family: &quot;Lucida Grande&quot;, &quot;Lucida Sans Unicode&quot;, Arial, Verdana, sans-serif; white-space: normal;">现在<span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">varnish</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">配置基本完成，可以在</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">8080</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">端口上启动</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">varnish</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">，并进行一些基本的测试。</span></p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 14px; text-indent: 28px; color: rgb(0, 0, 0); font-family: &quot;Lucida Grande&quot;, &quot;Lucida Sans Unicode&quot;, Arial, Verdana, sans-serif; white-space: normal;"><strong style="margin: 0px; padding: 0px; border: 0px; outline: 0px;">Varnish<span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 黑体;">启动等管理工具</span></strong></p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 14px; text-indent: 28px; color: rgb(0, 0, 0); font-family: &quot;Lucida Grande&quot;, &quot;Lucida Sans Unicode&quot;, Arial, Verdana, sans-serif; white-space: normal;">一般情况下，启动Varnish的命令为：</p><blockquote style="margin-top: 0px; margin-bottom: 1em; margin-left: 2.5em; padding-top: 10px; padding-right: 15px; padding-bottom: 10px; border-width: 1px; border-top-style: solid; border-right-style: solid; border-bottom-style: solid; border-top-color: rgb(221, 221, 221); border-right-color: rgb(221, 221, 221); border-bottom-color: rgb(221, 221, 221); border-image: initial; outline: 0px; font-size: 0.9em; background: rgb(247, 247, 247); color: rgb(0, 0, 0); font-family: &quot;Lucida Grande&quot;, &quot;Lucida Sans Unicode&quot;, Arial, Verdana, sans-serif; white-space: normal;"><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; text-indent: 28px;">varnishd -f /etc/varnish/default.vcl -s malloc,2G -T 127.0.0.1:2000 -a 0. 0.0.0:8080</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; text-indent: 28px;">-f / etc/varnish/default.vcl</p></blockquote><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 14px; text-indent: 28px; color: rgb(0, 0, 0); font-family: &quot;Lucida Grande&quot;, &quot;Lucida Sans Unicode&quot;, Arial, Verdana, sans-serif; white-space: normal;">&nbsp;</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 14px; text-indent: 28px; color: rgb(0, 0, 0); font-family: &quot;Lucida Grande&quot;, &quot;Lucida Sans Unicode&quot;, Arial, Verdana, sans-serif; white-space: normal;">–f<span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">选项</span>用于指定Varnishd使用的配置文件的路径。</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 14px; text-indent: 28px; color: rgb(0, 0, 0); font-family: &quot;Lucida Grande&quot;, &quot;Lucida Sans Unicode&quot;, Arial, Verdana, sans-serif; white-space: normal;">-s malloc,2G中的–s<span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">选项用来确定</span>Varnish<span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">使用的存储类型和存储容量，</span>这里使用的是<span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">malloc</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">类型（</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">malloc</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">是一个</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">C</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">函数，用于分配内存空间），</span>2G&nbsp;<span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">定义多少内存被</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">malloced</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">。</span></p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 14px; text-indent: 28px; color: rgb(0, 0, 0); font-family: &quot;Lucida Grande&quot;, &quot;Lucida Sans Unicode&quot;, Arial, Verdana, sans-serif; white-space: normal;">-T 127.0.0.1:2000是Varnish<span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">基于文本</span>方式的一个管理接口，启动后可以在不停止Varnish<span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">的情况下来管理</span>Varnish<span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">。管理</span>端口<span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">2000</span>可以指定。因为不是任何人都可以访问Varnish<span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">管理</span>端口，所以这里推荐只监听本机端口。</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 14px; text-indent: 28px; color: rgb(0, 0, 0); font-family: &quot;Lucida Grande&quot;, &quot;Lucida Sans Unicode&quot;, Arial, Verdana, sans-serif; white-space: normal;">-a 0.0.0.0:80中<span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">-a</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">选项表示</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">V</span>arnish<span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">监听所有</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">IP</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">发给</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">80</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">端口的</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">HTTP</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">请求</span>。</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 14px; text-indent: 28px; color: rgb(0, 0, 0); font-family: &quot;Lucida Grande&quot;, &quot;Lucida Sans Unicode&quot;, Arial, Verdana, sans-serif; white-space: normal;">varnishd -n /app/soft/varnish/cache -f /app/soft/varnish/etc/varnish/vcl.conf -a 0.0.0.0:80 -s file,/app/soft/varnish/cache/varnish_cache.data,5G -u daemon -w 2,65536,60 -T 127.0.0.1:3600 -p thread_pool_min=200 -p thread_pool_max=4000 -p thread_pools=4 -p thread_pool_add_delay=2 -p listen_depth=4096 -p lru_interval=20</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 14px; text-indent: 28px; color: rgb(0, 0, 0); font-family: &quot;Lucida Grande&quot;, &quot;Lucida Sans Unicode&quot;, Arial, Verdana, sans-serif; white-space: normal;">varnishncsa -n /data/apps/varnish/cache -a -w /var/log/vlogs &amp;启动<span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">varnishncsa</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">用来将</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">Varnish</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">访问日志写入日志文件。</span></p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 14px; text-indent: 28px; color: rgb(0, 0, 0); font-family: &quot;Lucida Grande&quot;, &quot;Lucida Sans Unicode&quot;, Arial, Verdana, sans-serif; white-space: normal;">-a address:port # Varnishd<span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">命令用于指定监听的地址及其端口</span></p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 14px; text-indent: 28px; color: rgb(0, 0, 0); font-family: &quot;Lucida Grande&quot;, &quot;Lucida Sans Unicode&quot;, Arial, Verdana, sans-serif; white-space: normal;">-b address:port #<span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">命令用于指定后台服务器地址及其端口</span></p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 14px; text-indent: 28px; color: rgb(0, 0, 0); font-family: &quot;Lucida Grande&quot;, &quot;Lucida Sans Unicode&quot;, Arial, Verdana, sans-serif; white-space: normal;">-d #&nbsp;<span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">使用</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">debug</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">模式</span></p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 14px; text-indent: 28px; color: rgb(0, 0, 0); font-family: &quot;Lucida Grande&quot;, &quot;Lucida Sans Unicode&quot;, Arial, Verdana, sans-serif; white-space: normal;">-f file # varnishd<span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">服务器存取规则文件</span></p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 14px; text-indent: 28px; color: rgb(0, 0, 0); font-family: &quot;Lucida Grande&quot;, &quot;Lucida Sans Unicode&quot;, Arial, Verdana, sans-serif; white-space: normal;">-F # 在后台运行</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 14px; text-indent: 28px; color: rgb(0, 0, 0); font-family: &quot;Lucida Grande&quot;, &quot;Lucida Sans Unicode&quot;, Arial, Verdana, sans-serif; white-space: normal;">-P file # PID文件</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 14px; text-indent: 28px; color: rgb(0, 0, 0); font-family: &quot;Lucida Grande&quot;, &quot;Lucida Sans Unicode&quot;, Arial, Verdana, sans-serif; white-space: normal;">-p param=value #&nbsp;<span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">服务器参数，用来优化性能</span></p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 14px; text-indent: 28px; color: rgb(0, 0, 0); font-family: &quot;Lucida Grande&quot;, &quot;Lucida Sans Unicode&quot;, Arial, Verdana, sans-serif; white-space: normal;">-s kind[,storageoptions] #&nbsp;<span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">缓存内容存放方式</span></p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 14px; text-indent: 28px; color: rgb(0, 0, 0); font-family: &quot;Lucida Grande&quot;, &quot;Lucida Sans Unicode&quot;, Arial, Verdana, sans-serif; white-space: normal;">-s file<span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">，</span>使用文件做为缓存，其路径、大小等</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 14px; text-indent: 28px; color: rgb(0, 0, 0); font-family: &quot;Lucida Grande&quot;, &quot;Lucida Sans Unicode&quot;, Arial, Verdana, sans-serif; white-space: normal;">-T address:port # telnet<span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">管理地址及其端口</span></p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 14px; text-indent: 28px; color: rgb(0, 0, 0); font-family: &quot;Lucida Grande&quot;, &quot;Lucida Sans Unicode&quot;, Arial, Verdana, sans-serif; white-space: normal;">现在Varnish<span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">已经正常运行，</span>以上主要解释了使用内存作为存储方式启动命令行，也是比较常用的一种方式。接下来我们来看一下有哪些常用的工具。</p><h4 style="margin-top: 0px; margin-bottom: 0px; padding: 0px; border: 0px; outline: 0px; font-size: 20px; font-weight: normal; line-height: 1.1em; font-family: &quot;Lucida Grande&quot;, &quot;Lucida Sans Unicode&quot;, Arial, Verdana, sans-serif; white-space: normal;">Varnishtop</h4><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 14px; text-indent: 28px; color: rgb(0, 0, 0); font-family: &quot;Lucida Grande&quot;, &quot;Lucida Sans Unicode&quot;, Arial, Verdana, sans-serif; white-space: normal;">这个工具用于读取共享内存的日志，适当使用一些过滤选项如–I<span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">，</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">-i</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">，</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">-X</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">和</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">-x</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">，</span>可以连续不断地显示大部分普通日志。Varnishtop可以按照使用要求显示请求的内容、客户端、浏览器等一些其他日志里的信息。比如：</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 14px; text-indent: 28px; color: rgb(0, 0, 0); font-family: &quot;Lucida Grande&quot;, &quot;Lucida Sans Unicode&quot;, Arial, Verdana, sans-serif; white-space: normal;">使用varnishtop -i rxurl查看客户端请求的<span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">url</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">次数</span>；</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 14px; text-indent: 28px; color: rgb(0, 0, 0); font-family: &quot;Lucida Grande&quot;, &quot;Lucida Sans Unicode&quot;, Arial, Verdana, sans-serif; white-space: normal;">使用Varnishtop -i txurl查看请求后端服务器的<span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">url</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">次数</span>；</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 14px; text-indent: 28px; color: rgb(0, 0, 0); font-family: &quot;Lucida Grande&quot;, &quot;Lucida Sans Unicode&quot;, Arial, Verdana, sans-serif; white-space: normal;">使用Varnishtop -i Rxheader –I Accept-Encoding查看接收到的头信息中有多少次包含</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 14px; text-indent: 28px; color: rgb(0, 0, 0); font-family: &quot;Lucida Grande&quot;, &quot;Lucida Sans Unicode&quot;, Arial, Verdana, sans-serif; white-space: normal;">Accept-Encoding<span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">。</span></p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 14px; text-indent: 28px; color: rgb(0, 0, 0); font-family: &quot;Lucida Grande&quot;, &quot;Lucida Sans Unicode&quot;, Arial, Verdana, sans-serif; white-space: normal;"><strong style="margin: 0px; padding: 0px; border: 0px; outline: 0px;"><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; color: rgb(136, 136, 136);">Varnishhist</span></strong></p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 14px; text-indent: 28px; color: rgb(0, 0, 0); font-family: &quot;Lucida Grande&quot;, &quot;Lucida Sans Unicode&quot;, Arial, Verdana, sans-serif; white-space: normal;">用于读取Varnishd<span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">共享内存段的日志，</span>并生成一个连续的柱状图。<span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">Varnishhist</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">用于</span>显示最后<span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">N</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">个请求的处理情况。如果缓存命中</span>则标记“|”，如果缓存没有命中则标记“#”符号。</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 14px; text-indent: 28px; color: rgb(0, 0, 0); font-family: &quot;Lucida Grande&quot;, &quot;Lucida Sans Unicode&quot;, Arial, Verdana, sans-serif; white-space: normal;"><strong style="margin: 0px; padding: 0px; border: 0px; outline: 0px;">Varnishsizes</strong></p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 14px; text-indent: 28px; color: rgb(0, 0, 0); font-family: &quot;Lucida Grande&quot;, &quot;Lucida Sans Unicode&quot;, Arial, Verdana, sans-serif; white-space: normal;">Varnishsizes<span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">和</span>Varnishhist<span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">相似，可以</span>查看服务对象的大致大小。</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 14px; text-indent: 28px; color: rgb(0, 0, 0); font-family: &quot;Lucida Grande&quot;, &quot;Lucida Sans Unicode&quot;, Arial, Verdana, sans-serif; white-space: normal;"><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; color: rgb(136, 136, 136);"><strong style="margin: 0px; padding: 0px; border: 0px; outline: 0px;">Varnishstat</strong></span></p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 14px; text-indent: 28px; color: rgb(0, 0, 0); font-family: &quot;Lucida Grande&quot;, &quot;Lucida Sans Unicode&quot;, Arial, Verdana, sans-serif; white-space: normal;">用于查看Varnish<span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">计数丢失率</span>、命中率、存储信息、创建线程、删除对象等。</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 14px; text-indent: 28px; color: rgb(0, 0, 0); font-family: &quot;Lucida Grande&quot;, &quot;Lucida Sans Unicode&quot;, Arial, Verdana, sans-serif; white-space: normal;"><strong style="margin: 0px; padding: 0px; border: 0px; outline: 0px;">FAQ</strong></p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 14px; text-indent: 28px; color: rgb(0, 0, 0); font-family: &quot;Lucida Grande&quot;, &quot;Lucida Sans Unicode&quot;, Arial, Verdana, sans-serif; white-space: normal;">Q：某些HTML页面的http头信息中常带有no-cache头，如何缓存？</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 14px; text-indent: 28px; color: rgb(0, 0, 0); font-family: &quot;Lucida Grande&quot;, &quot;Lucida Sans Unicode&quot;, Arial, Verdana, sans-serif; white-space: normal;">A<span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">：常规的配置无法实现缓存，需要修改</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">Varnish</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">配置文件，要去掉</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">http</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">头信息中的里</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">no-cache</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">头，修改如下内容</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">:</span></p><blockquote style="margin-top: 0px; margin-bottom: 1em; margin-left: 2.5em; padding-top: 10px; padding-right: 15px; padding-bottom: 10px; border-width: 1px; border-top-style: solid; border-right-style: solid; border-bottom-style: solid; border-top-color: rgb(221, 221, 221); border-right-color: rgb(221, 221, 221); border-bottom-color: rgb(221, 221, 221); border-image: initial; outline: 0px; font-size: 0.9em; background: rgb(247, 247, 247); color: rgb(0, 0, 0); font-family: &quot;Lucida Grande&quot;, &quot;Lucida Sans Unicode&quot;, Arial, Verdana, sans-serif; white-space: normal;"><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; text-indent: 28px;">sub vcl_fetch {</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; text-indent: 28px;">if (req.url ～ “html$”) {</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; text-indent: 28px;">set beresp.ttl = 10m;</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; text-indent: 28px;">set beresp.do_gzip = true;</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; text-indent: 28px;">unset beresp.http.Cache-Control;</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; text-indent: 28px;">unset beresp.http.Pragma;</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; text-indent: 28px;">set beresp.http.Cache-Control = “max-age=60″;</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; text-indent: 28px;">unset beresp.http.Expires;</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; text-indent: 28px;">}</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; text-indent: 28px;">}</p></blockquote><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 14px; text-indent: 28px; color: rgb(0, 0, 0); font-family: &quot;Lucida Grande&quot;, &quot;Lucida Sans Unicode&quot;, Arial, Verdana, sans-serif; white-space: normal;">如果<span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">html</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">页面带有</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">cookie</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">，还需要在</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">sub vcl</span>_recv { }&nbsp;<span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">配置中添加如下内容：</span></p><blockquote style="margin-top: 0px; margin-bottom: 1em; margin-left: 2.5em; padding-top: 10px; padding-right: 15px; padding-bottom: 10px; border-width: 1px; border-top-style: solid; border-right-style: solid; border-bottom-style: solid; border-top-color: rgb(221, 221, 221); border-right-color: rgb(221, 221, 221); border-bottom-color: rgb(221, 221, 221); border-image: initial; outline: 0px; font-size: 0.9em; background: rgb(247, 247, 247); color: rgb(0, 0, 0); font-family: &quot;Lucida Grande&quot;, &quot;Lucida Sans Unicode&quot;, Arial, Verdana, sans-serif; white-space: normal;"><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; text-indent: 28px;">sub vcl_recv {</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; text-indent: 28px;">if (req.request == “GET” &amp;&amp; req.url ～ “\.(js|css|html|jpg|png|gif|swf|jpeg| ico)$”) {</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; text-indent: 28px;">unset req.http.cookie;</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; text-indent: 28px;">}</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; text-indent: 28px;">}</p></blockquote><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 14px; text-indent: 28px; color: rgb(0, 0, 0); font-family: &quot;Lucida Grande&quot;, &quot;Lucida Sans Unicode&quot;, Arial, Verdana, sans-serif; white-space: normal;">Q：可以在32位机器上运行Varnish吗？</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 14px; text-indent: 28px; color: rgb(0, 0, 0); font-family: &quot;Lucida Grande&quot;, &quot;Lucida Sans Unicode&quot;, Arial, Verdana, sans-serif; white-space: normal;">A<span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">：</span>可以，不过<span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">32</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">位机器不支持大于</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">2G</span>B的文件存储，所以推荐使用<span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">64</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">位机器。</span></p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 14px; text-indent: 28px; color: rgb(0, 0, 0); font-family: &quot;Lucida Grande&quot;, &quot;Lucida Sans Unicode&quot;, Arial, Verdana, sans-serif; white-space: normal;">Q：Varnish可以做正向代理吗？</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 14px; text-indent: 28px; color: rgb(0, 0, 0); font-family: &quot;Lucida Grande&quot;, &quot;Lucida Sans Unicode&quot;, Arial, Verdana, sans-serif; white-space: normal;">A<span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">：</span>不可以，Varnish<span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">需要配置所有后端服务器到</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">VCL</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">。</span></p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 14px; text-indent: 28px; color: rgb(0, 0, 0); font-family: &quot;Lucida Grande&quot;, &quot;Lucida Sans Unicode&quot;, Arial, Verdana, sans-serif; white-space: normal;">Q：怎样做才能在后端服务器记录客户端的IP地址？</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 14px; text-indent: 28px; color: rgb(0, 0, 0); font-family: &quot;Lucida Grande&quot;, &quot;Lucida Sans Unicode&quot;, Arial, Verdana, sans-serif; white-space: normal;">A<span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">：这是缓存服务器常常遇到的问题。</span>X-Forwarded-For的相关解释已经在前面讲述，只要在后面的<span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">Web</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">服务器日志格式中加上相关参数即可。</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">Apache</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">的日志格式定义类似，为</span>Log Format “%{X-Forwarded-For}i %l %u %t /”%r/” %&gt;s %b /”%{Referer}i/” /”% {User-Agent}i/”&quot; varnishlog</p><blockquote style="margin-top: 0px; margin-bottom: 1em; margin-left: 2.5em; padding-top: 10px; padding-right: 15px; padding-bottom: 10px; border-width: 1px; border-top-style: solid; border-right-style: solid; border-bottom-style: solid; border-top-color: rgb(221, 221, 221); border-right-color: rgb(221, 221, 221); border-bottom-color: rgb(221, 221, 221); border-image: initial; outline: 0px; font-size: 0.9em; background: rgb(247, 247, 247); color: rgb(0, 0, 0); font-family: &quot;Lucida Grande&quot;, &quot;Lucida Sans Unicode&quot;, Arial, Verdana, sans-serif; white-space: normal;"><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 12.6px; text-indent: 28px;">CustomLog /var/log/apache2.log varnishlog</p></blockquote><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 14px; text-indent: 28px; color: rgb(0, 0, 0); font-family: &quot;Lucida Grande&quot;, &quot;Lucida Sans Unicode&quot;, Arial, Verdana, sans-serif; white-space: normal;">Q：Varnish可以加速https吗？</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 14px; text-indent: 28px; color: rgb(0, 0, 0); font-family: &quot;Lucida Grande&quot;, &quot;Lucida Sans Unicode&quot;, Arial, Verdana, sans-serif; white-space: normal;">A<span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">：</span>目前还不行，欲知相关信息请密切关注官方网站。</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 14px; text-indent: 28px; color: rgb(0, 0, 0); font-family: &quot;Lucida Grande&quot;, &quot;Lucida Sans Unicode&quot;, Arial, Verdana, sans-serif; white-space: normal;">Q：可以查看Varnish缓存了哪些内容吗？</p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 14px; text-indent: 28px; color: rgb(0, 0, 0); font-family: &quot;Lucida Grande&quot;, &quot;Lucida Sans Unicode&quot;, Arial, Verdana, sans-serif; white-space: normal;">A<span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">：</span>目前不可能，如果一个命令列出所有缓存的内容，那么缓存的内容是上千万或者更多，这样会导致因系统资源紧张而使<span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: &quot;Times New Roman&quot;;">Varnish</span><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; font-family: 宋体;">暂停服务。</span></p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 14px; text-indent: 28px; color: rgb(0, 0, 0); font-family: &quot;Lucida Grande&quot;, &quot;Lucida Sans Unicode&quot;, Arial, Verdana, sans-serif; white-space: normal;"><span style="margin: 0px; padding: 0px; border: 0px; outline: 0px; color: rgb(136, 136, 136);"><strong style="margin: 0px; padding: 0px; border: 0px; outline: 0px;">刘鑫，运维工程师，从事IT培训、技术支持、高性能网站架构等相关技术的研究工作，ChinaUnix社区集群和高可用版块资深版主。</strong></span></p><p style="margin-top: 0px; margin-bottom: 15px; padding: 0px; border: 0px; outline: 0px; font-size: 14px; text-indent: 28px; color: rgb(0, 0, 0); font-family: &quot;Lucida Grande&quot;, &quot;Lucida Sans Unicode&quot;, Arial, Verdana, sans-serif; white-space: normal;"><strong style="margin: 0px; padding: 0px; border: 0px; outline: 0px;">本文节选自《高性能网站构建实战》一书，部分内容有删减。刘鑫著，由人民邮电出版社出版。</strong></p><p><br/></p>
						</p>
				
				</div>
							
							
				
					<!--PC版-->
<div id="SOHUCS" sid="请将此处替换为配置SourceID的语句"></div>
<script charset="utf-8" type="text/javascript" src="http://changyan.sohu.com/upload/changyan.js" ></script>
<script type="text/javascript">
window.changyan.api.config({
appid: 'cyrSeBu12',
conf: 'prod_f811d5fceb1ba81cb014a75f67caf941'
});
</script>

			</div>
		

		</div>
		<div class="col-md-4 col-sm-12">
				<div class="skills">
				<h2 class="white">Skills</h2>
				<strong>PHP MySQL</strong>
				<span class="pull-right">80%</span>
					<div class="progress">
						<div class="progress-bar progress-bar-primary" role="progressbar" 
                        aria-valuenow="80" aria-valuemin="0" aria-valuemax="100" style="width: 80%;"></div>
					</div>
				<strong>html/css</strong>
				<span class="pull-right">85%</span>
					<div class="progress">
						<div class="progress-bar progress-bar-primary" role="progressbar" 
                        aria-valuenow="85" aria-valuemin="0" aria-valuemax="100" style="width: 85%;"></div>
					</div>
				<strong>js</strong>
				<span class="pull-right">75%</span>
					<div class="progress">
						<div class="progress-bar progress-bar-primary" role="progressbar" 
                        aria-valuenow="75" aria-valuemin="0" aria-valuemax="100" style="width: 75%;"></div>
					</div>
					
			</div>
		</div>
	</div>
</section>

 
<!-- footer section -->
<footer>
	<div class="container">
		<div class="row">
			<div class="col-md-12 col-sm-12">
				<p>Copyright &copy; 2016.yangakw All rights reserved. </p>
				<ul class="social-icons">
					<li><a href="#" class="fa fa-facebook"></a></li>
                    <li><a href="#" class="fa fa-google-plus"></a></li>
					<li><a href="#" class="fa fa-twitter"></a></li>
					<li><a href="#" class="fa fa-dribbble"></a></li>
					<li><a href="#" class="fa fa-github"></a></li>
					<li><a href="#" class="fa fa-behance"></a></li>
				</ul>
			</div>
		</div>
	</div>
</footer>

<!-- javascript js -->	
<script src="../theme/js/jquery.js"></script>
<script src="../theme/js/bootstrap.min.js"></script>	
<script src="../theme/js/jquery.backstretch.min.js"></script>
<script src="../theme/js/custom.js"></script>

</body>
</html>